<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ó–∞–∫–∞–∑–∞—Ç—å —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 20px;
      background-color: #f7f7f7;
    }
    form {
      width: 90%;
      max-width: 500px;
      margin: auto;
      padding: 24px;
      background-color: white;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    input, textarea, button {
      width: 100%;
      padding: 14px 12px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background-color: #007BFF;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #fileError {
      color: red;
      font-size: 0.9em;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 24px 28px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      position: relative;
    }
    .close {
      color: #aaa;
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #000;
    }
  </style>
</head>
<body>

<h2 style="text-align:center;">–ó–∞–∫–∞–∑–∞—Ç—å —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é</h2>

<form id="orderForm" action="/" method="post" enctype="multipart/form-data">
  <label for="name">–ò–º—è *</label>
  <input type="text" id="name" name="name" required>
  <label for="email">Email *</label>
  <input type="email" id="email" name="email" required>
  <label for="message">–°–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
  <textarea id="message" name="message" rows="4"></textarea>
  <label for="file">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª (id.txt) *</label>
  <input type="file" id="file" name="file" accept=".txt" required>
  <span id="fileError"></span>
  <button type="submit">–ó–∞–∫–∞–∑–∞—Ç—å —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é</button>
</form>

<!-- üßä –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="errorModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <p id="modalText" style="margin-bottom: 1em; color: #c00; font-weight: bold;"></p>
    <p id="recommendationText" style="margin-top: 0.5em;"></p>
  </div>
</div>

<script>
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã id.txt
  document.getElementById("orderForm").addEventListener("submit", function(event) {
    event.preventDefault();
    const fileInput = document.getElementById("file");
    const fileError = document.getElementById("fileError");
    const file = fileInput.files[0];
    fileError.textContent = "";
    if (!file || file.name !== "id.txt") {
      fileError.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª id.txt";
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
      const content = e.target.result.replace(/\r/g, '');
      const lines = content.split('\n');
      const requiredPrefixes = [
        { prefix: "UserName=", length: 9 },
        { prefix: "ComputerName=", length: 13 },
        { prefix: "Domain=", length: 7 },
        { prefix: "DiskSerial=", length: 11 }
      ];
      for (let i = 0; i < requiredPrefixes.length; i++) {
        const line = lines[i] || "";
        const required = requiredPrefixes[i];
        if (line.slice(0, required.prefix.length) !== required.prefix) {
          showModal("–û—à–∏–±–∫–∞ –≤ id.txt: –Ω–∞—Ä—É—à–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞", `
            –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:<br>
            –£–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª <code>id.txt</code>.<br>
            –ó–∞–ø—É—Å—Ç–∏—Ç–µ <code>test.vbe</code>.<br>
            –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.<br>
            –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ —Å –Ω–æ–≤—ã–º <code>id.txt</code>.<br>`);
          return;
        }
      }
      const computerNameValue = lines[1].slice(13);
      const diskSerialValue = lines[3].slice(11);
      if (computerNameValue === "" || computerNameValue.includes(" ")) {
        showModal("–û—à–∏–±–∫–∞ –≤ id.txt: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –∏–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞", "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ª–∏ –∑–∞–ø—É—â–µ–Ω —Ñ–∞–π–ª test.vbe.");
        return;
      }
      if (diskSerialValue === "" || diskSerialValue.includes(" ")) {
        showModal("–û—à–∏–±–∫–∞ –≤ id.txt: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –¥–∏—Å–∫–∞", "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∏—Å–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.");
        return;
      }
      // –í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
      document.getElementById("orderForm").submit();
    };
    reader.readAsText(file);
  });

  // üì¶ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  function showModal(message, recommendation) {
    document.getElementById("modalText").textContent = message;
    document.getElementById("recommendationText").innerHTML = recommendation;
    document.getElementById("errorModal").style.display = "block";
  }

  // üîÅ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Flask
  const status = "{{ status | default('') }}";
  const message = "{{ message | default('') }}";
  const recommendation = "{{ recommendation | default('') }}";
  if (status) {
    showModal(message, recommendation);
  }

  // ‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞
  document.getElementById("closeModal").onclick = function() {
    document.getElementById("errorModal").style.display = "none";
    if (status === 'success') {
      window.location.href = "https://kandval.com";
    }
  };
  window.onclick = function(event) {
    if (event.target === document.getElementById("errorModal")) {
      document.getElementById("errorModal").style.display = "none";
      if (status === 'success') {
        window.location.href = "https://kandval.com";
      }
    }
  };
</script>

</body>
</html>
