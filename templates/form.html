<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ó–∞–∫–∞–∑–∞—Ç—å —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 20px;
      background-color: #f7f7f7;
    }
    form {
      width: 90%;
      max-width: 500px;
      margin: auto;
      padding: 24px;
      background-color: white;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    input, textarea, button {
      width: 100%;
      padding: 14px 12px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
    }
    input:focus, textarea:focus {
      border-color: #007BFF;
      outline: none;
    }
    button {
      background-color: #007BFF;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    #fileError {
      color: red;
      font-size: 0.9em;
      margin-top: -4px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.4);
      animation: fadeIn 0.3s ease;
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 24px 28px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      position: relative;
      transform: translateY(-30px);
      opacity: 0;
      animation: slideUp 0.3s ease forwards;
    }
    .close {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 16px;
      font-size: 26px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #000;
    }
    @keyframes fadeIn {
      from { background-color: rgba(0,0,0,0); }
      to   { background-color: rgba(0,0,0,0.4); }
    }
    @keyframes slideUp {
      from {
        transform: translateY(-30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    @media (max-width: 600px) {
      body { padding: 10px; }
      form { padding: 18px; }
      input, textarea, button { font-size: 16px; padding: 12px; }
      .modal-content {
        margin: 30% auto;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <a href="https://kandval.com" style="font-size: 16px; text-decoration: none;">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ —Å–∞–π—Ç</a>
  <a href="https://kandval.com" style="font-size: 24px; text-decoration: none;">‚úï</a>
</div>

<h2 style="text-align:center;">–ó–∞–∫–∞–∑–∞—Ç—å —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é</h2>
<form id="orderForm" action="/" method="post" enctype="multipart/form-data">
  <label for="name">–ò–º—è *</label>
  <input type="text" id="name" name="name" required>
  <label for="email">Email *</label>
  <input type="email" id="email" name="email" required>
  <label for="message">–°–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
  <textarea id="message" name="message" rows="4"></textarea>
  <label for="file">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª (id.txt) *</label>
  <input type="file" id="file" name="file" accept=".txt" required>
  <span id="fileError"></span>
  <button type="submit">–ó–∞–∫–∞–∑–∞—Ç—å —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é</button>
</form>

<!-- ‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="errorModal" class="modal">
  <div class="modal-content animate">
    <span class="close" id="closeModal">&times;</span>
    <p id="modalText" style="margin-bottom: 1em; color: #c00; font-weight: bold;"></p>
    <p id="recommendationText" style="margin-top: 0.5em;"></p>
  </div>
</div>

<script>
// ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
const universalRecommendation = `
  –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:<br>
  –£–¥–∞–ª–∏—Ç–µ <code>id.txt</code>.<br>
  –ó–∞–ø—É—Å—Ç–∏—Ç–µ <code>test.vbe</code>.<br>
  –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.<br>
  –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ —Å –Ω–æ–≤—ã–º <code>id.txt</code>.`;

// üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã id.txt + –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
document.getElementById("orderForm").addEventListener("submit", function(event) {
  event.preventDefault();

  if (!navigator.onLine) {
    showModal(
      "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.",
      "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ç–∏ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã."
    );
    return;
  }

  const fileInput = document.getElementById("file");
  const fileError = document.getElementById("fileError");
  const file = fileInput.files[0];
  const errorMessage = "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª id.txt";
  fileError.textContent = "";

  if (!file || file.name !== "id.txt") {
    fileError.textContent = errorMessage;
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result.replace(/\r/g, '');
    const lines = content.split('\n');
    const requiredPrefixes = [
      { prefix: "UserName=", length: 9 },
      { prefix: "ComputerName=", length: 13 },
      { prefix: "Domain=", length: 7 },
      { prefix: "DiskSerial=", length: 11 }
    ];
    for (let i = 0; i < requiredPrefixes.length; i++) {
      const line = lines[i] || "";
      const required = requiredPrefixes[i];
      if (!line.startsWith(required.prefix)) {
        showModal("–û—à–∏–±–∫–∞ –≤ id.txt: –Ω–∞—Ä—É—à–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞", universalRecommendation);
        return;
      }
    }
    const computerNameValue = lines[1].slice(13);
    const diskSerialValue = lines[3].slice(11);
    if (computerNameValue === "" || computerNameValue.includes(" ")) {
      showModal("–û—à–∏–±–∫–∞ –≤ id.txt: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –∏–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞.", universalRecommendation);
      return;
    }
    if (diskSerialValue === "" || diskSerialValue.includes(" ")) {
      showModal("–û—à–∏–±–∫–∞ –≤ id.txt: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –¥–∏—Å–∫–∞.", universalRecommendation);
      return;
    }

    // ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ fetch
    const form = document.getElementById("orderForm");
    const formData = new FormData(form);

    fetch("/", {
      method: "POST",
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      showModal(data.message, data.recommendation);
      if (data.status === 'success') {
        setTimeout(() => {
          window.location.href = "https://kandval.com";
        }, 3000);
      }
    })
    .catch(error => {
      showModal("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞.", "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
    });
  };
  reader.readAsText(file);
});

// üßä showModal –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
function showModal(message = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞", recommendation = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞.") {
  document.getElementById("modalText").textContent = message;
  document.getElementById("recommendationText").innerHTML = recommendation;
  document.getElementById("errorModal").style.display = "block";

  // ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
  document.getElementById("closeModal").onclick = function() {
    document.getElementById("errorModal").style.display = "none";
  };
  window.onclick = function(event) {
    if (event.target === document.getElementById("errorModal")) {
      document.getElementById("errorModal").style.display = "none";
    }
  };
}

// üß© –°–µ—Ä–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ç—É—Å ‚Äî –æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –ø—Ä–∏–¥—ë—Ç —á–µ—Ä–µ–∑ render_template (—Ä–µ–∑–µ—Ä–≤)
const status = "{{ status | default('') }}";
const message = "{{ message | default('') }}";
const recommendation = "{{ recommendation | default('') }}";

if (status) {
  const modal = document.getElementById('errorModal');
  document.getElementById('modalText').textContent = message;
  document.getElementById('recommendationText').innerHTML = recommendation;
  modal.style.display = 'block';

  document.getElementById("closeModal").onclick = function() {
    modal.style.display = "none";
    if (status === 'success') {
      window.location.href = "https://kandval.com";
    }
  };
  window.onclick = function(event) {
    if (event.target === modal) {
      modal.style.display = "none";
      if (status === 'success') {
        window.location.href = "https://kandval.com";
      }
    }
  };
}
</script>

</body>
</html>

